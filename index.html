<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Kur’an (Yaşar Nuri) – Okuyucu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">

  <style>
    :root{
      --bg:#0e121b; --fg:#e6e7eb; --muted:#a7b0bf; --card:#121826; --border:#223147; --accent:#2a6ae6;
    }
    .light{
      --bg:#fbfbf7; --fg:#0e223a; --muted:#5a6a82; --card:#ffffff; --border:#d9dee7; --accent:#1f4fd1;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{
      font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      background:var(--bg); color:var(--fg); line-height:1.8;
      -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    }

    /* Non-sticky title row */
    header{background:var(--bg); border-bottom:1px solid var(--border)}
    .wrap{max-width:900px;margin:0 auto}
    .headrow{display:flex;gap:8px;align-items:center;padding:12px 16px}
    .grow{flex:1}
    .pill{background:var(--card);padding:6px 10px;border-radius:999px;border:1px solid var(--border)}

    /* Sticky nav lives OUTSIDE header */
    .navwrap{
      position:-webkit-sticky; position:sticky; top:0; z-index:1000;
      background:var(--bg);
      border-top:1px solid var(--border); border-bottom:1px solid var(--border);
      will-change:top;
    }
    .navgrid{
      display:grid;
      grid-template-columns:56px minmax(0,1fr) 56px;
      gap:8px; align-items:center;
      padding:10px 16px;
      white-space:nowrap;   /* never wrap */
    }
    .navgrid select{
      width:100%; min-width:0;
      overflow:hidden; text-overflow:ellipsis;
      background:var(--card); color:var(--fg);
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px;
    }
    .pick{
      width:56px;height:42px;display:inline-flex;align-items:center;justify-content:center;
      background:var(--card); color:var(--fg);
      border:1px solid var(--border); border-radius:10px; font-weight:700; letter-spacing:.3px; padding:0; user-select:none; cursor:pointer;
    }

    /* Controls (top-right) */
    button{
      background:var(--card); color:var(--fg);
      border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px; cursor:pointer;
    }

    /* Content */
    main{padding:16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
    .surah-title{font-size:22px;font-weight:700;margin:8px 0 12px}
    .verse{padding:12px 14px;border-left:3px solid var(--border);margin:8px 0;border-radius:8px}
    .verse b{color:var(--muted);font-weight:600}
    .muted{color:var(--muted)}
    .footer{text-align:center;color:var(--muted);font-size:12px;padding:24px 0 40px}
    .hidden{display:none}

    /* Tighten on very small screens */
    @media (max-width:380px){
      .headrow{padding:10px 12px}
      .navgrid{padding:8px 12px;gap:6px;grid-template-columns:52px minmax(0,1fr) 52px}
      .pick{width:52px;height:40px}
      button,.navgrid select{font-size:15px}
    }
  </style>
</head>
<body>

  <!-- Non-sticky header -->
  <header>
    <div class="wrap headrow">
      <strong style="font-size:22px">Kur’an Oku</strong>
      <!-- <span class="pill">Yaşar Nuri Öztürk</span> -->
      <div class="grow"></div>
      <button id="decrease" title="Yazıyı küçült">A−</button>
      <button id="increase" title="Yazıyı büyüt">A+</button>
      <button id="themeBtn" title="Tema">Tema</button>
      <button id="installBtn" class="hidden">Yükle</button>
    </div>
  </header>

  <!-- Sticky nav outside header -->
  <div class="navwrap">
    <div class="wrap navgrid">
      <button id="prevSurah" class="pick" aria-label="Önceki sure">&laquo;&laquo;</button>
      <select id="surahSelect" title="Sure seç">
        <option>Yükleniyor…</option>
      </select>
      <button id="nextSurah" class="pick" aria-label="Sonraki sure">&raquo;&raquo;</button>
    </div>
  </div>

  <main class="wrap">
    <div id="meta" class="muted"></div>
    <div id="content" class="card"><div class="muted">Veri yükleniyor…</div></div>
  </main>

  <div class="footer wrap">Çevrimdışı çalışır. PWA olarak kurulabilir.</div>

  <script>
    let DATA=null;
    let fontSize=parseInt(localStorage.getItem("fs")||"18",10);
    let theme=localStorage.getItem("theme")||(window.matchMedia&&window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark');
    let deferredPrompt=null;

    const content=document.getElementById('content');
    const surahSelect=document.getElementById('surahSelect');
    const increase=document.getElementById('increase');
    const decrease=document.getElementById('decrease');
    const themeBtn=document.getElementById('themeBtn');
    const installBtn=document.getElementById('installBtn');
    const prevBtn=document.getElementById('prevSurah');
    const nextBtn=document.getElementById('nextSurah');
    const meta=document.getElementById('meta');

    function applyTheme(){ document.body.classList.toggle('light', theme==='light'); localStorage.setItem('theme',theme); }
    function applyFont(){ document.documentElement.style.fontSize=fontSize+"px"; localStorage.setItem("fs",String(fontSize)); }
    applyTheme(); applyFont();
    increase.onclick=()=>{ fontSize=Math.min(28,fontSize+1); applyFont(); };
    decrease.onclick=()=>{ fontSize=Math.max(14,fontSize-1); applyFont(); };
    themeBtn.onclick=()=>{ theme=theme==='light'?'dark':'light'; applyTheme(); };

    function cleanName(name){ return (name||"").replace(/^\s*\d+\.\s*/,""); }

    function renderSurahList(){
      surahSelect.innerHTML="";
      DATA.surahs.forEach(s=>{
        const opt=document.createElement('option');
        opt.value=s.number; opt.textContent=`${s.number}. ${cleanName(s.name_tr)}`;
        surahSelect.appendChild(opt);
      });
      const last=parseInt(localStorage.getItem('lastSurah')||DATA.surahs[0].number,10);
      if (DATA.surahs.some(x=>x.number===last)) surahSelect.value=String(last);
    }

    function renderSurah(num){
      const s=DATA.surahs.find(x=>x.number===Number(num)); if(!s) return;
      let html=`<div class="surah-title">${s.number}. ${cleanName(s.name_tr)}</div>`;
      s.verses.forEach(v=>{
        html+=`<div class="verse" id="v-${s.number}-${v.number}"><b>${s.number}:${v.number}</b> ${v.text_tr}</div>`;
      });
      content.innerHTML=html;
      localStorage.setItem('lastSurah',String(s.number));

      const key=`scroll-${s.number}`;
      const saved=parseInt(localStorage.getItem(key)||"0",10);
      window.scrollTo({ top: (!isNaN(saved)&&saved>0)?saved:0, behavior:'instant' });
    }

    function setSurah(num){ const n=Number(num)||DATA.surahs[0].number; surahSelect.value=String(n); renderSurah(n); }
    function nextSurah(){ const n=Number(surahSelect.value); const i=DATA.surahs.findIndex(s=>s.number===n); setSurah(DATA.surahs[(i+1)%DATA.surahs.length].number); }
    function prevSurah(){ const n=Number(surahSelect.value); const i=DATA.surahs.findIndex(s=>s.number===n); setSurah(DATA.surahs[(i-1+DATA.surahs.length)%DATA.surahs.length].number); }

    surahSelect.addEventListener('change',()=>setSurah(surahSelect.value));
    nextBtn.addEventListener('click',nextSurah);
    prevBtn.addEventListener('click',prevSurah);
    window.addEventListener('keydown',e=>{ if(e.key==='ArrowRight') nextSurah(); if(e.key==='ArrowLeft') prevSurah(); });

    let t;
    window.addEventListener('scroll',()=>{
      clearTimeout(t);
      const n=Number(surahSelect.value||0); if(!n) return;
      t=setTimeout(()=>{ localStorage.setItem(`scroll-${n}`,String(window.scrollY)); },150);
    });

    async function loadJSON(url){
      const res=await fetch(url,{cache:'reload'}); if(!res.ok) throw new Error("JSON yüklenemedi: "+res.status);
      DATA=await res.json(); if(!DATA?.surahs?.length) throw new Error("Beklenen format değil");
      renderMeta(); renderSurahList(); setSurah(surahSelect.value||DATA.surahs[0].number);
    }
    function renderMeta(){
      const {source,locale,translator,retrieved_at}=DATA.metadata||{};
      // meta.textContent=`Kaynak: ${source||''} | Dil: ${locale||''} | Çevirmen: ${translator||''} | Tarih: ${retrieved_at||''}`;
    }
    loadJSON('./data/quranix_yasarnuri_simple.json').catch(err=>{ content.innerHTML=`<div class="muted">Hata: ${err.message}</div>`; });

    window.addEventListener('beforeinstallprompt',(e)=>{ e.preventDefault(); deferredPrompt=e; installBtn.classList.remove('hidden'); });
    installBtn.addEventListener('click',async()=>{ if(!deferredPrompt) return; deferredPrompt.prompt(); await deferredPrompt.userChoice; installBtn.classList.add('hidden'); deferredPrompt=null; });

    if('serviceWorker' in navigator){ window.addEventListener('load',()=>navigator.serviceWorker.register('./sw.js').catch(console.error)); }
  </script>
</body>
</html>