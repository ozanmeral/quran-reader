<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8">
  <title>Kur’an (Yaşar Nuri) – Okuyucu</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <meta name="theme-color" content="#0f172a">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
<style>
  :root {
    --bg:#0b0f19; --fg:#e5e7eb; --muted:#94a3b8; --card:#111827; --border:#1f2937; --accent:#2563eb;
  }
  .light {
    --bg:#ffffff; --fg:#0f172a; --muted:#475569; --card:#f8fafc; --border:#e2e8f0; --accent:#1d4ed8;
  }
  * { box-sizing: border-box; }
  body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--fg); }
  header { position:sticky; top:0; z-index:5; background:rgba(11,15,25,.9); backdrop-filter:saturate(140%) blur(6px); border-bottom:1px solid var(--border); }
  .light header { background:rgba(255,255,255,.9); }
  .wrap { max-width: 900px; margin: 0 auto; padding: 12px 16px; }
  .toolbar { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  select, input[type="text"], button { background:var(--card); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:10px 12px; font-size:16px; }
  button { cursor:pointer }
  .card { background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; }
  .surah-title { font-size:20px; font-weight:700; margin:8px 0 12px; }
  .verse { padding:10px 12px; border-left:3px solid var(--border); margin:6px 0; border-radius:6px; line-height:1.6; }
  .verse b { color:var(--muted) }
  .muted { color:var(--muted) }
  .flex { display:flex; gap:8px; align-items:center; }
  .grow { flex:1 }
  .pill { background:var(--card); padding:6px 10px; border-radius:999px; border:1px solid var(--border); }
  .footer { text-align:center; color:var(--muted); font-size:12px; padding:24px 0 40px; }
  .hidden { display:none }
  mark { background:rgba(37,99,235,.25); padding:0 2px; }
</style>
</head>
<body>
<header>
  <div class="wrap toolbar">
    <strong>Kur’an Okuyucu</strong>
    <span class="pill">Yaşar Nuri Öztürk</span>
    <div class="grow"></div>
    <button id="decrease">A−</button>
    <button id="increase">A+</button>
    <button id="themeBtn">Tema</button>
    <button id="installBtn" class="hidden">Yükle</button>
  </div>
  <div class="wrap toolbar" style="padding-top:0">
    <select id="surahSelect" title="Sure seç">
      <option>Yükleniyor…</option>
    </select>
    <input id="search" class="grow" type="text" placeholder="Ayet içinde ara">
    <button id="clearSearch">Temizle</button>
  </div>
</header>

<main class="wrap" style="padding-top:16px">
  <div id="meta" class="muted"></div>
  <div id="content" class="card">
    <div class="muted">Veri yükleniyor…</div>
  </div>
</main>

<div class="footer wrap">
  Çevrimdışı çalışır. PWA olarak kurulabilir. JSON statikse siteye koy.
</div>

<script>
  // State
  let DATA = null;
  let fontSize = parseInt(localStorage.getItem("fs") || "18", 10);
  let theme = localStorage.getItem("theme") || "dark"; // "dark" | "light"
  let deferredPrompt = null;

  // UI refs
  const content = document.getElementById('content');
  const surahSelect = document.getElementById('surahSelect');
  const searchInput = document.getElementById('search');
  const clearBtn = document.getElementById('clearSearch');
  const increase = document.getElementById('increase');
  const decrease = document.getElementById('decrease');
  const themeBtn = document.getElementById('themeBtn');
  const installBtn = document.getElementById('installBtn');
  const meta = document.getElementById('meta');

  // Apply theme and font
  function applyTheme() {
    document.body.classList.toggle('light', theme === 'light');
    localStorage.setItem('theme', theme);
  }
  function applyFont() {
    document.documentElement.style.fontSize = fontSize + "px";
    localStorage.setItem("fs", String(fontSize));
  }
  applyTheme(); applyFont();

  increase.onclick = () => { fontSize = Math.min(28, fontSize + 1); applyFont(); };
  decrease.onclick = () => { fontSize = Math.max(14, fontSize - 1); applyFont(); };
  themeBtn.onclick = () => { theme = theme === 'light' ? 'dark' : 'light'; applyTheme(); };

  // Helpers
  function cleanName(name) { return (name || "").replace(/^\s*\d+\.\s*/, ""); }

  function renderSurahList() {
    surahSelect.innerHTML = "";
    DATA.surahs.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.number;
      opt.textContent = `${s.number}. ${cleanName(s.name_tr)}`;
      surahSelect.appendChild(opt);
    });

    // Son kaldığı sureyi seç
    const lastSurah = parseInt(localStorage.getItem('lastSurah') || DATA.surahs[0].number, 10);
    if (DATA.surahs.some(x => x.number === lastSurah)) {
      surahSelect.value = String(lastSurah);
    }
  }

  function renderSurah(num, q="") {
    const s = DATA.surahs.find(x => x.number === Number(num));
    if (!s) return;
    let html = `<div class="surah-title">${s.number}. ${cleanName(s.name_tr)}</div>`;
    const needle = q.trim().toLowerCase();
    s.verses.forEach(v => {
      let text = v.text_tr;
      if (needle) {
        const re = new RegExp("(" + needle.replace(/[.*+?^${}()|[\]\\]/g, '\\$&') + ")", "gi");
        text = text.replace(re, '<mark>$1</mark>');
      }
      html += `<div class="verse" id="v-${s.number}-${v.number}"><b>${s.number}:${v.number}</b> ${text}</div>`;
    });
    content.innerHTML = html;

    // Kayıt
    localStorage.setItem('lastSurah', String(s.number));

    // Sure bazlı scroll geri yükleme
    const key = `scroll-${s.number}`;
    const saved = parseInt(localStorage.getItem(key) || "0", 10);
    if (!isNaN(saved) && saved > 0) {
      window.scrollTo({ top: saved, behavior: 'instant' });
    }
  }

  function renderMeta() {
    const { source, locale, translator, retrieved_at } = DATA.metadata || {};
    meta.textContent = `Kaynak: ${source || ''} | Dil: ${locale || ''} | Çevirmen: ${translator || ''} | Tarih: ${retrieved_at || ''}`;
  }

  // JSON yükle
  async function loadJSON(url) {
    const res = await fetch(url, { cache: 'reload' });
    if (!res.ok) throw new Error("JSON yüklenemedi: " + res.status);
    DATA = await res.json();
    if (!DATA?.surahs?.length) throw new Error("Beklenen format değil");
    renderMeta();
    renderSurahList();
    renderSurah(Number(surahSelect.value || DATA.surahs[0].number), searchInput.value);
  }

  // Olaylar
  surahSelect.addEventListener('change', () => renderSurah(surahSelect.value, searchInput.value));
  searchInput.addEventListener('input', () => renderSurah(surahSelect.value, searchInput.value));
  clearBtn.addEventListener('click', () => { searchInput.value = ""; renderSurah(surahSelect.value, ""); });

  // Scroll pozisyonunu per-sure kaydet
  let t;
  window.addEventListener('scroll', () => {
    clearTimeout(t);
    const n = Number(surahSelect.value || 0);
    if (!n) return;
    t = setTimeout(() => {
      localStorage.setItem(`scroll-${n}`, String(window.scrollY));
    }, 150);
  });

  // İlk yükleme
  loadJSON('./data/quranix_yasarnuri_simple.json')
    .catch(err => { content.innerHTML = `<div class="muted">Hata: ${err.message}</div>`; });

  // PWA install
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault(); deferredPrompt = e; installBtn.classList.remove('hidden');
  });
  installBtn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt(); await deferredPrompt.userChoice;
    installBtn.classList.add('hidden'); deferredPrompt = null;
  });

  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => navigator.serviceWorker.register('./sw.js').catch(console.error));
  }
</script>
</body>
</html>