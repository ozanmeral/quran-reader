<!doctype html>
<html lang="tr">

<head>
  <meta charset="utf-8">
  <title>Kur‚Äôan Okuyucu</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <meta name="theme-color" content="#fdf6e3">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">

  <style>
    :root {
      --bg-color: #fdf6e3;
      --text-color: #2c3e50;
      --panel-bg: #ffffff;
      --border-color: #dcdcdc;
      --accent-color: #2c3e50;
      --highlight: #e67e22;
      --nav-height: 70px;
      --header-height: 60px;
    }

    body.dark-mode {
      --bg-color: #121212;
      --text-color: #e0e0e0;
      --panel-bg: #1e1e1e;
      --border-color: #333333;
      --accent-color: #90caf9;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      overflow: hidden;
      /* Ana sayfa kaymasƒ±n */
      overscroll-behavior: none;
      /* T√ºm esnemeleri kapat */
    }

    /* --- √úST BAR --- */
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: var(--panel-bg);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      padding-top: env(safe-area-inset-top);
      z-index: 20;
    }

    h1 {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--accent-color);
    }

    .settings-btn svg {
      width: 26px;
      height: 26px;
      fill: currentColor;
    }

    .settings-btn {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      padding: 10px;
    }

    /* --- SLIDER KUTUSU --- */
    #slider-container {
      position: absolute;
      top: var(--header-height);
      bottom: var(--nav-height);
      left: 0;
      width: 100%;
      overflow: hidden;
    }

    #slider-track {
      display: flex;
      width: 300%;
      /* 3 Vagon */
      height: 100%;
      transform: translateX(-33.3333%);
      /* Ortayƒ± g√∂ster */
      will-change: transform;
    }

    /* --- TEKƒ∞L SAYFA (VAGON) --- */
    .slide {
      width: 33.3333%;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 20px 16px;
      padding-bottom: 40px;

      /* Lastik etkisini (Bounce) kapatan sihirli kod */
      overscroll-behavior-y: none;
    }

    /* --- ƒ∞√áERƒ∞K STƒ∞LLERƒ∞ --- */
    .surah-header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 15px;
    }

    .surah-name {
      font-size: 1.8rem;
      font-weight: 900;
      color: var(--highlight);
      display: block;
    }

    .basmala-container {
      text-align: center;
      font-family: 'Georgia', serif;
      font-size: 1.3rem;
      margin: 20px 0 40px 0;
      color: var(--text-color);
      opacity: 0.8;
    }

    .verse-container {
      font-family: 'Georgia', serif;
      line-height: 1.7;
      margin-bottom: 24px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .verse-num {
      display: inline-block;
      background-color: var(--border-color);
      color: var(--text-color);
      font-size: 0.85rem;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 8px;
      margin-right: 8px;
      vertical-align: text-top;
      font-family: sans-serif;
    }

    .footnote-ref {
      color: var(--highlight);
      font-weight: bold;
      cursor: pointer;
      font-size: 0.75em;
      vertical-align: super;
      margin: 0 2px;
      text-decoration: none;
    }

    .footnote-content {
      font-family: 'Georgia', serif;
      line-height: 1.6;
      font-size: 1.1rem;
      overflow-y: auto;
      flex: 1;
      padding-bottom: 150px;
    }

    .footnote-content p {
      margin-bottom: 15px;
    }

    .footnote-content a {
      color: var(--highlight);
      text-decoration: underline;
      cursor: pointer;
    }

    .inline-verse {
      background-color: var(--bg-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      margin: 10px 0;
      font-size: 0.95rem;
      color: var(--text-color);
      font-style: italic;
    }

    /* --- ALT NAVƒ∞GASYON --- */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: var(--panel-bg);
      border-top: 1px solid var(--border-color);
      display: grid;
      grid-template-columns: 60px 1fr 80px 60px;
      gap: 5px;
      align-items: center;
      z-index: 20;
      padding: 5px;
      padding-bottom: calc(5px + env(safe-area-inset-bottom));
    }

    .nav-btn {
      background: var(--bg-color);
      border: none;
      border-radius: 8px;
      color: var(--text-color);
      font-size: 1.5rem;
      cursor: pointer;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .nav-select {
      height: 100%;
      padding: 0 10px;
      font-size: 1rem;
      font-weight: bold;
      background-color: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      text-align: center;
    }

    /* --- MODAL --- */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      z-index: 50;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }

    .modal-overlay.active {
      display: flex;
    }

    .settings-modal {
      background: var(--panel-bg);
      width: 90%;
      max-width: 400px;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    #footnoteModal .settings-modal {
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 10px;
    }

    .setting-row {
      margin-bottom: 20px;
    }

    .setting-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
    }

    select,
    .btn-group button,
    #installBtn {
      width: 100%;
      padding: 12px;
      border-radius: 8px;
      background: var(--bg-color);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      font-size: 1rem;
    }

    .btn-group {
      display: flex;
    }

    .btn-group button:first-child {
      border-radius: 8px 0 0 8px;
      border-right: none;
    }

    .btn-group button:last-child {
      border-radius: 0 8px 8px 0;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 2rem;
      color: var(--text-color);
    }

    .hidden {
      display: none !important;
    }

    #loading-msg {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.2rem;
      color: var(--text-color);
    }

    /* --- ARAMA SONU√áLARI --- */
    .search-result-item {
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
      cursor: pointer;
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .result-header {
      font-size: 0.9rem;
      font-weight: bold;
      color: var(--highlight);
      margin-bottom: 5px;
    }

    .result-text {
      font-family: 'Georgia', serif;
      line-height: 1.5;
      font-size: 1rem;
      color: var(--text-color);
    }

    .highlight {
      background-color: rgba(230, 126, 34, 0.3);
      border-radius: 3px;
      padding: 0 2px;
      font-weight: bold;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .header-icon {
      background: none;
      border: none;
      color: var(--text-color);
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
    }

    .header-icon svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }

    .hidden {
      display: none !important;
    }

    /* --- FAB (Floating Action Button) --- */
    .fab-btn {
      position: fixed;
      bottom: calc(var(--nav-height) + 20px);
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background-color: var(--highlight);
      color: #fff;
      border: none;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 30;
      transition: transform 0.2s;
    }

    .fab-btn:active {
      transform: scale(0.95);
    }

    .fab-btn svg {
      width: 28px;
      height: 28px;
      fill: currentColor;
    }

    /* --- Inline Verse Go To Icon --- */
    .inline-verse-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 5px;
    }

    .goto-icon {
      cursor: pointer;
      color: var(--highlight);
      display: flex;
      align-items: center;
      padding: 5px;
    }

    .goto-icon svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }
  </style>
</head>

<body>

  <header>
    <div class="header-left">
      <!-- Back Button -->
      <button class="header-icon hidden" id="backBtn">
        <svg viewBox="0 0 24 24">
          <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
        </svg>
      </button>
      <!-- Home Button (Book Logo) -->
      <button class="header-icon" id="homeBtn">
        <svg viewBox="0 0 24 24">
          <path
            d="M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.41.21.75-.19.75-.6V6c0-.22-.04-.42-.12-.58-.1-.2-.26-.33-.46-.42zM21 18.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z" />
        </svg>
      </button>
    </div>

    <button class="settings-btn" id="openSettings">
      <svg viewBox="0 0 24 24">
        <path
          d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z" />
      </svg>
    </button>
  </header>

  <div class="modal-overlay" id="settingsModal">
    <div class="settings-modal">
      <div class="modal-header">
        <h2>Ayarlar</h2><button class="close-btn" id="closeSettings">&times;</button>
      </div>
      <div class="setting-row"><label class="setting-label">√áeviri</label><select id="sourceSelect"></select></div>
      <div class="setting-row"><label class="setting-label">G√∂r√ºn√ºm</label><select id="themeSelect">
          <option value="light">‚òÄÔ∏è Aydƒ±nlƒ±k</option>
          <option value="dark">üåô Karanlƒ±k</option>
        </select></div>
      <div class="setting-row"><label class="setting-label">Yazƒ± Boyutu</label>
        <div class="btn-group"><button id="fontDec">A-</button><button id="fontInc">A+</button></div>
      </div>
      <div id="installContainer" class="setting-row hidden"><button id="installBtn">Uygulamayƒ± Y√ºkle</button></div>
    </div>
  </div>

  <div class="modal-overlay" id="footnoteModal">
    <div class="settings-modal">
      <div class="modal-header">
        <div style="flex:1"></div><button class="close-btn" id="closeFootnote">&times;</button>
      </div>
      <div id="footnoteBody" class="footnote-content"></div>
    </div>
  </div>

  <div class="modal-overlay" id="searchModal">
    <div class="settings-modal" style="height: 80vh; display: flex; flex-direction: column;">
      <div class="modal-header">
        <h2>Arama</h2><button class="close-btn" id="closeSearch">&times;</button>
      </div>
      <div class="search-box" style="margin-bottom: 15px; display: flex; gap: 10px;">
        <input type="text" id="searchInput" placeholder="Ara..."
          style="flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 1rem;">
        <button id="searchBtn"
          style="padding: 0 20px; border-radius: 8px; background: var(--accent-color); color: #fff; border: none; font-weight: bold; cursor: pointer;">Ara</button>
      </div>
      <div id="searchResults" style="flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;">
        <div style="text-align: center; color: var(--text-color); opacity: 0.7; margin-top: 50px;">
          Aranacak kelimeyi yazƒ±n...
        </div>
      </div>
    </div>
  </div>

  <div id="slider-container">
    <div id="slider-track">
      <div class="slide" id="slide-prev"></div>
      <div class="slide" id="slide-curr">
        <div id="loading-msg">Y√ºkleniyor...</div>
      </div>
      <div class="slide" id="slide-next"></div>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn" id="prevBtn"><svg style="width:30px;height:30px;fill:currentColor" viewBox="0 0 24 24">
        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
      </svg></button>
    <select id="navSurahSelect" class="nav-select"></select>
    <select id="navVerseSelect" class="nav-select"></select>
    <button class="nav-btn" id="nextBtn"><svg style="width:30px;height:30px;fill:currentColor" viewBox="0 0 24 24">
        <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
      </svg></button>
  </nav>

  <!-- Floating Action Button for Search -->
  <button id="fabSearch" class="fab-btn">
    <svg viewBox="0 0 24 24">
      <path
        d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
    </svg>
  </button>

  <script>
    const SOURCES = [{ id: 'yasar', name: 'Ya≈üar Nuri √ñzt√ºrk', file: 'data/quranix_yasarnuri_simple.json' }, { id: 'mesaj', name: 'Edip Y√ºksel - Mesaj', file: 'data/quranix_mesaj_simple.json' }];

    let state = {
      data: null,
      sourceId: localStorage.getItem('q_source') || SOURCES[0].id,
      surah: 1,
      fontSize: parseInt(localStorage.getItem('q_fontSize')) || 22,
      theme: localStorage.getItem('q_theme') || 'light',
      isNavigating: false
    };

    const track = document.getElementById('slider-track');
    const slides = {
      prev: document.getElementById('slide-prev'),
      curr: document.getElementById('slide-curr'),
      next: document.getElementById('slide-next')
    };
    const nav = {
      surah: document.getElementById('navSurahSelect'),
      verse: document.getElementById('navVerseSelect'),
      prev: document.getElementById('prevBtn'),
      next: document.getElementById('nextBtn')
    };

    async function init() {
      applyTheme();
      applyFontSize();
      setupSettings();
      await loadData(state.sourceId);

      const last = JSON.parse(localStorage.getItem('q_lastPos') || '{"surah":1, "scroll":0}');
      state.surah = last.surah;

      updateSlidesContent();

      // ƒ∞lk a√ßƒ±lƒ±≈üta scroll pozisyonunu ayarla
      setTimeout(() => {
        if (slides.curr) slides.curr.scrollTop = last.scroll;
      }, 150);

      setupGestures();

      // History Handling
      window.onpopstate = (event) => {
        if (event.state) {
          // Restore state
          state.surah = event.state.surah;
          updateSlidesContent();

          // Restore scroll
          if (event.state.scroll) {
            setTimeout(() => {
              if (slides.curr) slides.curr.scrollTop = event.state.scroll;
            }, 50);
          }

          // Restore Modal if it was open
          if (event.state.modalOpen) {
            // Re-open modal logic could be complex depending on content
            // For now, we assume if we pop back, we might want to close modal if it was a navigation *from* modal
            // But if we are going BACK to a state where modal was open, we should open it.
            // However, simpler approach: If we navigated AWAY from modal, popping back should restore context.
            // Let's rely on the fact that we are back in the Surah.
            // If we want to restore the exact modal, we need to save modal content in state.

            if (event.state.modalContent) {
              // document.getElementById('footnoteTitle').innerText = event.state.modalTitle;
              document.getElementById('footnoteBody').innerHTML = event.state.modalContent;
              document.getElementById('footnoteModal').classList.add('active');
              // Re-attach listeners
              attachFootnoteListeners();
            }
          } else {
            document.getElementById('footnoteModal').classList.remove('active');
          }

          // Toggle Back Button Visibility
          const backBtn = document.getElementById('backBtn');
          if (event.state.isDeep) {
            backBtn.classList.remove('hidden');
          } else {
            backBtn.classList.add('hidden');
          }
        }
      };

      // Initial state replace
      history.replaceState({
        surah: state.surah,
        scroll: 0,
        modalOpen: false,
        isDeep: false
      }, "", "");

      // Header Button Listeners
      document.getElementById('homeBtn').onclick = () => {
        if (state.surah !== 1) {
          state.surah = 1;
          updateSlidesContent();
          scrollToVerse(1);
          history.pushState({ surah: 1, scroll: 0, modalOpen: false, isDeep: false }, "", "");
          document.getElementById('backBtn').classList.add('hidden');
        } else {
          scrollToVerse(1);
        }
      };

      document.getElementById('backBtn').onclick = () => {
        history.back();
      };
    }

    async function loadData(sid) {
      try {
        const src = SOURCES.find(s => s.id === sid);
        const res = await fetch(src.file);
        state.data = await res.json();
        localStorage.setItem('q_source', sid);

        nav.surah.innerHTML = state.data.surahs.map(s =>
          `<option value="${s.number}">${s.number}. ${s.name_tr.replace(/^\d+\.\s*/, '')}</option>`
        ).join('');
      } catch (e) {
        slides.curr.innerHTML = `<div style="text-align:center;padding:50px">Hata: ${e.message}</div>`;
      }
    }

    function getSurahHTML(num) {
      const s = state.data.surahs.find(x => x.number === num);
      if (!s) return "";

      let html = `<div class="surah-header"><span class="surah-name">${s.name_tr}</span></div>`;

      if (num !== 1 && num !== 9) {
        const fatiha = state.data.surahs.find(x => x.number === 1);
        // Besmele sonundaki dipnot numarasƒ±nƒ± temizle (√∂rn: "1")
        const basmala = fatiha ? fatiha.verses[0].text_tr.replace(/\s*\d+\s*$/, '') : "Besmele...";
        html += `<div class="basmala-container">${basmala}</div>`;
      }

      html += s.verses.map(v => {
        // Metin i√ßindeki sayƒ±larƒ± dipnot linkine √ßevir
        const text = v.text_tr.replace(/\b(\d+)\b/g, (match) => {
          return `<sup class="footnote-ref" onclick="showFootnote(${num}, ${v.number}, ${match})">${match}</sup>`;
        });

        return `
        <div class="verse-container" id="s${num}-v${v.number}">
          <span class="verse-num">${v.number}</span>${text}
        </div>
      `}).join('');

      html += '<div style="height:100px"></div>';
      return html;
    }

    window.showFootnote = function (sNum, vNum, fNum) {
      const s = state.data.surahs.find(x => x.number === sNum);
      if (!s) return;
      const v = s.verses.find(x => x.number === vNum);
      if (!v || !v.footnotes) return;

      // Dipnot metnini bul
      // Yeni format: <br/><strong>Dipnot X</strong>...
      // Eski format: Dipnot X...
      let content = v.footnotes.find(f => {
        // HTML taglerini temizleyip kontrol et veya direkt string i√ßinde ara
        return f.includes(`Dipnot ${fNum}`) || f.startsWith(`${fNum}.`);
      });

      // Bulamazsa ve dipnot varsa, hepsini g√∂ster (fallback)
      if (!content && v.footnotes.length > 0) {
        content = v.footnotes.join('<hr/>');
      }

      if (content) {
        // document.getElementById('footnoteTitle').innerText = `Dipnot ${fNum}`;
        const body = document.getElementById('footnoteBody');
        body.innerHTML = content; // HTML olarak render et
        attachFootnoteListeners();
        document.getElementById('footnoteModal').classList.add('active');
      }
    };

    function attachFootnoteListeners() {
      const body = document.getElementById('footnoteBody');

      // 1. Re-attach listeners to existing GoTo icons (restored from history)
      const existingGoToBtns = body.querySelectorAll('.goto-icon');
      existingGoToBtns.forEach(btn => {
        btn.onclick = (e) => {
          e.stopPropagation();
          const s = parseInt(btn.getAttribute('data-surah'));
          const v = parseInt(btn.getAttribute('data-ayah'));
          handleGoToClick(s, v);
        };
      });

      // 2. Attach listeners to links
      const links = body.querySelectorAll('a');
      links.forEach(link => {
        link.onclick = (e) => {
          e.preventDefault();

          // Check for existing expanded element via aria-controls
          const controlledId = link.getAttribute('aria-controls');
          if (controlledId) {
            const controlledEl = document.getElementById(controlledId);
            if (controlledEl) {
              controlledEl.remove();
              link.removeAttribute('aria-controls');
              return;
            } else {
              // Cleanup stale attribute if element not found
              link.removeAttribute('aria-controls');
            }
          }

          // √ñncelik: data attribute'larƒ± (eƒüer varsa) veya href parsing
          let targetSurah = link.getAttribute('surah');
          let targetVerse = link.getAttribute('ayah');

          if (!targetSurah || !targetVerse) {
            // Fallback: href parsing
            const href = link.getAttribute('href');
            const match = href.match(/\/(\d+)(?:#(\d+))?/);
            if (match) {
              targetSurah = match[1];
              targetVerse = match[2] || 1;
            }
          }

          if (targetSurah) {
            targetSurah = parseInt(targetSurah);
            targetVerse = parseInt(targetVerse);

            // Fallback check: next sibling (for legacy or mixed state)
            const nextSibling = link.nextElementSibling;
            if (nextSibling && nextSibling.classList.contains('inline-verse')) {
              nextSibling.remove();
              return;
            }

            // Fetch verse text
            const s = state.data.surahs.find(x => x.number === targetSurah);
            if (s) {
              const v = s.verses.find(x => x.number === targetVerse);
              if (v) {
                const div = document.createElement('div');
                div.className = 'inline-verse';
                // Generate unique ID
                const uniqueId = `inline-verse-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
                div.id = uniqueId;
                link.setAttribute('aria-controls', uniqueId);

                // Create Header with GoTo Icon
                const header = document.createElement('div');
                header.className = 'inline-verse-header';
                header.innerHTML = `<strong>${s.name_tr} ${targetSurah}:${targetVerse}</strong>`;

                const gotoBtn = document.createElement('div');
                gotoBtn.className = 'goto-icon';
                // Store data for restoration
                gotoBtn.setAttribute('data-surah', targetSurah);
                gotoBtn.setAttribute('data-ayah', targetVerse);

                gotoBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4l-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"/></svg>`; // Arrow forward
                gotoBtn.onclick = (e) => {
                  e.stopPropagation(); // Prevent collapsing
                  handleGoToClick(targetSurah, targetVerse);
                };

                header.appendChild(gotoBtn);
                div.appendChild(header);

                const text = document.createElement('div');
                text.innerHTML = v.text_tr;
                div.appendChild(text);

                link.parentNode.insertBefore(div, link.nextSibling);
              }
            }
          }
        };
      });
    }

    function handleGoToClick(targetSurah, targetVerse) {
      // Save current state before navigating
      const currentScroll = slides.curr.scrollTop;
      const modalContent = document.getElementById('footnoteBody').innerHTML;
      // const modalTitle = document.getElementById('footnoteTitle').innerText;

      history.replaceState({
        surah: state.surah,
        scroll: currentScroll,
        modalOpen: true,
        modalTitle: "",
        modalContent: modalContent,
        isDeep: false
      }, "", "");

      // Navigate
      document.getElementById('footnoteModal').classList.remove('active');

      if (state.surah !== targetSurah) {
        state.surah = targetSurah;
        updateSlidesContent();
        setTimeout(() => scrollToVerse(targetVerse), 300);
      } else {
        scrollToVerse(targetVerse);
      }

      // Push new state
      history.pushState({
        surah: targetSurah,
        scroll: 0, // Approximate
        modalOpen: false,
        isDeep: true
      }, "", "");

      // Show Back Button
      document.getElementById('backBtn').classList.remove('hidden');
    }


    function scrollToVerse(vNum) {
      const vId = `s${state.surah}-v${vNum}`;
      const el = document.getElementById(vId);
      if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "center" });
        // Highlight effect
        el.style.backgroundColor = "rgba(230, 126, 34, 0.1)";
        setTimeout(() => el.style.backgroundColor = "", 2000);
      }
    }

    function updateSlidesContent() {
      slides.curr.innerHTML = getSurahHTML(state.surah);

      if (state.surah > 1) slides.prev.innerHTML = getSurahHTML(state.surah - 1);
      else slides.prev.innerHTML = "";

      if (state.surah < 114) slides.next.innerHTML = getSurahHTML(state.surah + 1);
      else slides.next.innerHTML = "";

      nav.surah.value = state.surah;
      updateVerseSelect();

      nav.prev.style.opacity = state.surah === 1 ? 0.3 : 1;
      nav.next.style.opacity = state.surah === 114 ? 0.3 : 1;

      slides.curr.onscroll = handleScroll;

      // Reset position
      track.style.transition = 'none';
      track.style.transform = 'translateX(-33.3333%)';
      state.isNavigating = false;
    }

    function updateVerseSelect() {
      const s = state.data.surahs.find(x => x.number === state.surah);
      if (!s) return;
      let opts = '<option value="0">Ayet</option>';
      for (let i = 1; i <= s.verses.length; i++) opts += `<option value="${i}">${i}</option>`;
      nav.verse.innerHTML = opts;
    }

    // --- GELƒ∞≈ûMƒ∞≈û SWIPE (Y√ñN Kƒ∞Lƒ∞Dƒ∞ VE HASSASƒ∞YET) ---
    function setupGestures() {
      let startX = 0;
      let startY = 0;
      let isDragging = false;
      let directionLocked = ''; // 'horizontal' veya 'vertical'
      let width = 0;

      track.addEventListener('touchstart', e => {
        if (state.isNavigating) return;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        isDragging = true;
        directionLocked = ''; // Hen√ºz y√∂n belli deƒüil
        width = track.offsetWidth / 3;
        track.style.transition = 'none';
      }, { passive: true });

      track.addEventListener('touchmove', e => {
        if (!isDragging || state.isNavigating) return;

        const currentX = e.touches[0].clientX;
        const currentY = e.touches[0].clientY;
        const diffX = currentX - startX;
        const diffY = currentY - startY;

        // Y√∂n Kilitleme Mantƒ±ƒüƒ±
        if (directionLocked === '') {
          if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 5) {
            // Dikey hareket baskƒ±n -> Kaydƒ±rmayƒ± serbest bƒ±rak (Scroll)
            directionLocked = 'vertical';
            isDragging = false; // Slider'ƒ± s√ºr√ºklemeyi bƒ±rak
            return;
          } else if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 5) {
            // Yatay hareket baskƒ±n -> Slider'ƒ± s√ºr√ºkle
            directionLocked = 'horizontal';
          }
        }

        // Eƒüer yatay kilitlendiyse Slider'ƒ± hareket ettir
        if (directionLocked === 'horizontal') {
          e.preventDefault(); // Tarayƒ±cƒ±nƒ±n ileri/geri gitmesini engelle
          const percentMove = (diffX / width) * 33.3333;
          track.style.transform = `translateX(calc(-33.3333% + ${diffX}px))`;
        }
      }, { passive: false }); // preventDefault i√ßin passive false

      track.addEventListener('touchend', e => {
        if (!isDragging || directionLocked !== 'horizontal') return;

        isDragging = false;
        const endX = e.changedTouches[0].clientX;
        const diff = endX - startX;
        const threshold = width * 0.25; // %25 e≈üik

        track.style.transition = 'transform 0.3s ease-out';

        if (diff > threshold && state.surah > 1) {
          // √ñnceki Sure
          state.isNavigating = true;
          track.style.transform = 'translateX(0%)';
          setTimeout(() => {
            state.surah--;
            updateSlidesContent();
            slides.curr.scrollTop = 0;
            savePos(0);
          }, 300);
        }
        else if (diff < -threshold && state.surah < 114) {
          // Sonraki Sure
          state.isNavigating = true;
          track.style.transform = 'translateX(-66.6666%)';
          setTimeout(() => {
            state.surah++;
            updateSlidesContent();
            slides.curr.scrollTop = 0;
            savePos(0);
          }, 300);
        }
        else {
          // Geri D√∂n
          track.style.transform = 'translateX(-33.3333%)';
        }
      });
    }

    // Butonla Gezinti
    function navigate(dir) {
      if (state.isNavigating) return;
      track.style.transition = 'transform 0.3s ease-out';
      state.isNavigating = true;

      if (dir === 'next' && state.surah < 114) {
        track.style.transform = 'translateX(-66.6666%)';
        setTimeout(() => {
          state.surah++;
          updateSlidesContent();
          slides.curr.scrollTop = 0;
          savePos(0);
        }, 300);
      } else if (dir === 'prev' && state.surah > 1) {
        track.style.transform = 'translateX(0%)';
        setTimeout(() => {
          state.surah--;
          updateSlidesContent();
          slides.curr.scrollTop = 0;
          savePos(0);
        }, 300);
      } else {
        state.isNavigating = false;
      }
    }

    let saveTimeout;
    function handleScroll(e) {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        savePos(e.target.scrollTop);
      }, 200);
    }

    function savePos(scrollY) {
      localStorage.setItem('q_lastPos', JSON.stringify({ surah: state.surah, scroll: scrollY }));
    }

    function setupSettings() {
      const modal = document.getElementById('settingsModal');
      document.getElementById('openSettings').onclick = () => modal.classList.add('active');
      document.getElementById('closeSettings').onclick = () => modal.classList.remove('active');
      modal.onclick = e => { if (e.target === modal) modal.classList.remove('active'); };

      const fModal = document.getElementById('footnoteModal');
      document.getElementById('closeFootnote').onclick = () => fModal.classList.remove('active');
      fModal.onclick = e => { if (e.target === fModal) fModal.classList.remove('active'); };

      document.getElementById('fontInc').onclick = () => { state.fontSize = Math.min(40, state.fontSize + 2); applyFontSize(); };
      document.getElementById('fontDec').onclick = () => { state.fontSize = Math.max(16, state.fontSize - 2); applyFontSize(); };

      document.getElementById('themeSelect').value = state.theme;
      document.getElementById('themeSelect').onchange = e => {
        state.theme = e.target.value; localStorage.setItem('q_theme', state.theme); applyTheme();
      };

      const sSelect = document.getElementById('sourceSelect');
      sSelect.innerHTML = SOURCES.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
      sSelect.value = state.sourceId;
      sSelect.onchange = e => loadData(e.target.value).then(() => updateSlidesContent());

      nav.prev.onclick = () => navigate('prev');
      nav.next.onclick = () => navigate('next');

      nav.surah.onchange = e => {
        state.surah = parseInt(e.target.value);
        updateSlidesContent();
        slides.curr.scrollTop = 0;
        savePos(0);
      };

      nav.verse.onchange = e => {
        const vId = `s${state.surah}-v${e.target.value}`;
        const el = document.getElementById(vId);
        if (el) el.scrollIntoView({ behavior: "smooth", block: "center" });
      };

      // PWA Install Logic
      const installContainer = document.getElementById('installContainer');
      const installBtn = document.getElementById('installBtn');

      // Listen for the install prompt
      window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        window.deferredPrompt = e;
        // Update UI notify the user they can install the PWA
        installContainer.classList.remove('hidden');
        console.log('PWA install prompt intercepted');
      });

      installBtn.addEventListener('click', async () => {
        const promptEvent = window.deferredPrompt;
        if (!promptEvent) return;

        // Show the install prompt
        promptEvent.prompt();

        // Wait for the user to respond to the prompt
        const { outcome } = await promptEvent.userChoice;
        console.log(`User response to the install prompt: ${outcome}`);

        // We've used the prompt, and can't use it again, throw it away
        window.deferredPrompt = null;

        // Hide the install button
        installContainer.classList.add('hidden');
      });

      // Hide button if app is successfully installed
      window.addEventListener('appinstalled', () => {
        console.log('PWA was installed');
        installContainer.classList.add('hidden');
        window.deferredPrompt = null;
      });

      // ARAMA
      const searchModal = document.getElementById('searchModal');
      const searchInput = document.getElementById('searchInput');
      const searchBtn = document.getElementById('searchBtn');
      const searchResults = document.getElementById('searchResults');



      document.getElementById('fabSearch').onclick = () => {
        searchModal.classList.add('active');
        setTimeout(() => searchInput.focus(), 100);
      };
      document.getElementById('closeSearch').onclick = () => searchModal.classList.remove('active');
      searchModal.onclick = e => { if (e.target === searchModal) searchModal.classList.remove('active'); };

      const doSearch = () => {
        const query = searchInput.value.trim();
        if (!query) return;

        searchResults.innerHTML = '<div style="text-align:center;padding:20px">Aranƒ±yor...</div>';

        // UI thread'i bloklamamak i√ßin kƒ±sa bir gecikme
        setTimeout(() => {
          const results = performSearch(query);
          renderSearchResults(results, query);
        }, 10);
      };

      searchBtn.onclick = doSearch;
      searchInput.onkeypress = e => { if (e.key === 'Enter') doSearch(); };
    }

    function performSearch(query) {
      if (!state.data) return [];

      // T√ºrk√ße karakterleri normalize et ve k√º√ß√ºk harfe √ßevir
      const normalize = str => str.toLocaleLowerCase('tr').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const tokens = query.split(/\s+/).map(normalize).filter(t => t.length > 0);

      if (tokens.length === 0) return [];

      const results = [];

      state.data.surahs.forEach(surah => {
        surah.verses.forEach(verse => {
          const text = verse.text_tr;
          const normText = normalize(text);

          // AND mantƒ±ƒüƒ±: T√ºm tokenlar ayette ge√ßmeli
          const allMatch = tokens.every(token => normText.includes(token));

          if (allMatch) {
            results.push({
              surah: surah.number,
              surahName: surah.name_tr,
              verse: verse.number,
              text: text
            });
          }
        });
      });

      return results;
    }

    function renderSearchResults(results, query) {
      const container = document.getElementById('searchResults');
      if (results.length === 0) {
        container.innerHTML = '<div style="text-align:center;padding:20px">Sonu√ß bulunamadƒ±.</div>';
        return;
      }

      const normalize = str => str.toLocaleLowerCase('tr').normalize("NFD").replace(/[\u0300-\u036f]/g, "");
      const tokens = query.split(/\s+/).map(normalize).filter(t => t.length > 0);

      const html = results.map(r => {
        // Highlight i≈ülemi
        let highlightedText = r.text;
        // Basit bir highlight mantƒ±ƒüƒ±: Orijinal metni koruyarak e≈üle≈üenleri i≈üaretle
        // Regex kullanarak case-insensitive replace yapmak daha karma≈üƒ±k olabilir √ß√ºnk√º T√ºrk√ße karakter sorunu var.
        // Bu y√ºzden basit√ße replace yapalƒ±m ama orijinal case'i korumak zor.
        // Alternatif: Metni tokenlara b√∂l√ºp kontrol etmek.

        // Daha saƒülam bir highlight i√ßin:
        // Metni kelimelere b√∂l, her kelimeyi normalize edip tokenlarla kar≈üƒ±la≈ütƒ±r.
        // E≈üle≈üirse <span class="highlight"> i√ßine al.

        // Not: Bu basit yakla≈üƒ±m kelime k√∂klerini veya ekleri tam tutturamayabilir ama i≈ü g√∂r√ºr.
        // Regex ile dinamik pattern olu≈üturup replace yapmayƒ± deneyelim.

        try {
          // Tokenlarƒ± birle≈ütirip regex olu≈ütur (g ve i flagleri ile)
          // T√ºrk√ße karakterler i√ßin i flag'i bazen yetersiz kalabilir, ama modern tarayƒ±cƒ±larda fena deƒüil.
          const pattern = new RegExp(`(${tokens.join('|')})`, 'gi');
          highlightedText = highlightedText.replace(pattern, '<span class="highlight">$1</span>');
        } catch (e) {
          console.error("Highlight error", e);
        }

        return `
          <div class="search-result-item" onclick="goToVerse(${r.surah}, ${r.verse})">
            <div class="result-header">${r.surahName} ${r.surah}:${r.verse}</div>
            <div class="result-text">${highlightedText}</div>
          </div>
        `;
      }).join('');

      container.innerHTML = `<div style="padding:10px;font-size:0.9rem;opacity:0.7">${results.length} sonu√ß bulundu</div>` + html;
    }

    function goToVerse(sNum, vNum) {
      document.getElementById('searchModal').classList.remove('active');

      // Eƒüer farklƒ± suredeysek oraya git
      if (state.surah !== sNum) {
        state.surah = sNum;
        updateSlidesContent();
      }

      // Ayete scroll et
      // updateSlidesContent asenkron deƒüil ama DOM update'i bekle
      setTimeout(() => {
        const vId = `s${sNum}-v${vNum}`;
        const el = document.getElementById(vId);
        if (el) {
          el.scrollIntoView({ behavior: "smooth", block: "center" });
          // Ge√ßici bir highlight efekti ver
          el.style.backgroundColor = "var(--highlight)";
          el.style.transition = "background-color 1s";
          setTimeout(() => el.style.backgroundColor = "transparent", 1000);
        }
      }, 300);
    }

    function applyFontSize() {
      localStorage.setItem('q_fontSize', state.fontSize);
      let style = document.getElementById('dyn-style');
      if (!style) { style = document.createElement('style'); style.id = 'dyn-style'; document.head.appendChild(style); }
      style.innerHTML = `.verse-container { font-size: ${state.fontSize}px !important; }`;
    }

    function applyTheme() {
      document.body.className = state.theme === 'dark' ? 'dark-mode' : '';
      const meta = document.querySelector("meta[name=theme-color]");
      meta.setAttribute("content", state.theme === 'dark' ? '#1e1e1e' : '#fdf6e3');
    }

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
    init();
  </script>
</body>

</html>